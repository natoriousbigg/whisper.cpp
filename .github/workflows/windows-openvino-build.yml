name: Windows OpenVINO Build

permissions:
  contents: read

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      upload_artifacts:
        required: false
        type: boolean
        default: true

jobs:
  build:
    name: Windows x64 (OpenVINO)
    runs-on: windows-latest
    env:
      OPENVINO_DOWNLOAD_URL: "https://storage.openvinotoolkit.org/repositories/openvino/packages/2024.6/windows/w_openvino_toolkit_windows_2024.6.0.17404.4c0f47d2335_x86_64.zip"
      OPENVINO_FOLDER_NAME: "w_openvino_toolkit_windows_2024.6.0.17404.4c0f47d2335_x86_64"

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: choco install ninja -y

      - name: Download and Extract OpenVINO Toolkit
        shell: powershell
        run: |
          Write-Host "Downloading OpenVINO toolkit from: $env:OPENVINO_DOWNLOAD_URL"
          try {
            Invoke-WebRequest -Uri $env:OPENVINO_DOWNLOAD_URL -OutFile openvino.zip -ErrorAction Stop
          } catch {
            throw "Failed to download OpenVINO toolkit: $_"
          }
          if (!(Test-Path openvino.zip)) {
            throw "Failed to download OpenVINO toolkit - file not found"
          }
          
          Write-Host "Extracting OpenVINO toolkit..."
          Expand-Archive -Path openvino.zip -DestinationPath openvino
          
          $openvinoRoot = Join-Path (Get-Location) "openvino" | Join-Path -ChildPath $env:OPENVINO_FOLDER_NAME
          if (!(Test-Path $openvinoRoot)) {
            throw "OpenVINO extraction failed - folder not found: $openvinoRoot"
          }
          
          Write-Host "OpenVINO extracted to: $openvinoRoot"
          "OPENVINO_ROOT=$openvinoRoot" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Configure OpenVINO Environment
        shell: powershell
        run: |
          $openvinoRoot = $env:OPENVINO_ROOT
          Write-Host "Setting up OpenVINO environment from: $openvinoRoot"
          
          $setupVars = Join-Path $openvinoRoot "setupvars.ps1"
          if (!(Test-Path $setupVars)) {
            throw "setupvars.ps1 not found at: $setupVars"
          }
          
          . $setupVars
          
          $cmakePath = Join-Path $openvinoRoot "runtime" | Join-Path -ChildPath "cmake"
          if (Test-Path $cmakePath) {
            "OpenVINO_DIR=$cmakePath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "Set OpenVINO_DIR=$cmakePath"
          } else {
            throw "OpenVINO cmake directory not found at: $cmakePath"
          }
          
          $binPath = Join-Path $openvinoRoot "runtime" | Join-Path -ChildPath "bin" | Join-Path -ChildPath "intel64" | Join-Path -ChildPath "Release"
          if (Test-Path $binPath) {
            "$binPath" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Added to PATH: $binPath"
          }
          
          $tbbPath = Join-Path $openvinoRoot "runtime" | Join-Path -ChildPath "3rdparty" | Join-Path -ChildPath "tbb" | Join-Path -ChildPath "bin"
          if (Test-Path $tbbPath) {
            "$tbbPath" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Added to PATH: $tbbPath"
          }
          
          Write-Host "[OK] OpenVINO environment configured successfully"

      - name: Configure
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          cmake -S . -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DGGML_AVX512=ON ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DGGML_STATIC=ON ^
            -DGGML_VULKAN=OFF ^
            -DWHISPER_OPENVINO=ON ^
            -DWHISPER_SDL2=OFF ^
            -DWHISPER_BUILD_TESTS=OFF ^
            -DWHISPER_BUILD_EXAMPLES=ON ^
            -DWHISPER_BUILD_SERVER=OFF

      - name: Build
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          cmake --build build --config Release -- -v

      - name: Package whisper-cli and whisper-bench
        if: ${{ inputs.upload_artifacts }}
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          
          Copy-Item build\bin\whisper-cli.exe dist\
          Copy-Item build\bin\whisper-bench.exe dist\
          
          if (Test-Path "build\bin\*.dll") {
            Copy-Item build\bin\*.dll dist\
          }
          
          $copiedDlls = 0
          $openvinoRoot = $env:OPENVINO_ROOT
          
          if ($openvinoRoot -and (Test-Path $openvinoRoot)) {
            Write-Host "Copying OpenVINO runtime DLLs from toolkit: $openvinoRoot"
            
            $binPath = Join-Path $openvinoRoot "runtime" | Join-Path -ChildPath "bin" | Join-Path -ChildPath "intel64" | Join-Path -ChildPath "Release"
            if (Test-Path $binPath) {
              Write-Host "Copying runtime DLLs from: $binPath"
              $runtimeDlls = Get-ChildItem "$binPath\*.dll" -ErrorAction SilentlyContinue
              if ($runtimeDlls) {
                $runtimeDlls | Copy-Item -Destination dist\
                $copiedDlls += $runtimeDlls.Count
                Write-Host "Copied $($runtimeDlls.Count) runtime DLL(s)"
                foreach ($dll in $runtimeDlls) {
                  Write-Host "  - $($dll.Name)"
                }
              }
            } else {
              Write-Host "Warning: Runtime bin path not found: $binPath"
            }
            
            $tbbPath = Join-Path $openvinoRoot "runtime" | Join-Path -ChildPath "3rdparty" | Join-Path -ChildPath "tbb" | Join-Path -ChildPath "bin"
            if (Test-Path $tbbPath) {
              Write-Host "Copying TBB DLLs from: $tbbPath"
              $tbbDlls = Get-ChildItem "$tbbPath\*.dll" -ErrorAction SilentlyContinue
              if ($tbbDlls) {
                $tbbDlls | Copy-Item -Destination dist\
                $copiedDlls += $tbbDlls.Count
                Write-Host "Copied $($tbbDlls.Count) TBB DLL(s)"
                foreach ($dll in $tbbDlls) {
                  Write-Host "  - $($dll.Name)"
                }
              }
            } else {
              Write-Host "Warning: TBB path not found: $tbbPath"
            }
            
            if ($copiedDlls -eq 0) {
              Write-Host "Error: No OpenVINO DLLs found in expected locations"
              Write-Host "Searched paths:"
              Write-Host "  - $binPath"
              Write-Host "  - $tbbPath"
              throw "No OpenVINO DLLs found - packaging failed"
            } else {
              Write-Host "Successfully copied $copiedDlls OpenVINO-related DLL(s)"
            }
          } else {
            throw "OPENVINO_ROOT not set or path does not exist"
          }
          
          Write-Host "Package contents:"
          Get-ChildItem dist\ | ForEach-Object { Write-Host "  - $($_.Name)" }

      - name: Upload artifacts
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-windows-x64-openvino
          path: dist/*
