name: CI

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
    paths: ['.github/workflows/build.yml',
            '**/CMakeLists.txt',
            '**/Makefile',
            '**/*.mk',
            '**/*.cmake',
            '**/*.in',
            '**/*.h',
            '**/*.hpp',
            '**/*.c',
            '**/*.cpp',
            '**/*.cu',
            '**/*.cuh',
            '**/*.cl',
            '**/*.swift',
            '**/*.m',
            '**/*.mm',
            '**/*.metal',
            '**/*.comp',
            '**/*.java']

  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create new release'
        required: true
        type: boolean
      pre_release_tag:
        description: 'Pre-release tag name'
        required: false
        type: string
      run_type:
        description: 'Workflow type to run'
        required: true
        type: choice
        options:
          - full-ci
          - release-only

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write  # for creating release

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  determine-tag:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.name }}
      should_release: ${{ steps.tag.outputs.should_release }}

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        shell: bash
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          CUSTOM_TAG="${{ github.event.inputs.pre_release_tag }}"
          SHOULD_RELEASE="false"

          echo "Raw values:"
          echo "BUILD_NUMBER: $BUILD_NUMBER"
          echo "SHORT_HASH: $SHORT_HASH"
          echo "BRANCH_NAME: ${{ env.BRANCH_NAME }}"
          echo "CUSTOM_TAG: $CUSTOM_TAG"

          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "Using pushed tag name"
            TAG_NAME="${{ github.ref_name }}"
            SHOULD_RELEASE="true"
          elif [[ -n "$CUSTOM_TAG" ]]; then
            echo "Using custom tag"
            TAG_NAME="${CUSTOM_TAG}"
            SHOULD_RELEASE="true"
          elif [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "Manual release requested"
            SHOULD_RELEASE="true"
            TAG_NAME="b${BUILD_NUMBER}"
          elif [[ "${{ env.BRANCH_NAME }}" == "master" ]]; then
            echo "Using master branch format"
            TAG_NAME="b${BUILD_NUMBER}"
            SHOULD_RELEASE="false"
          else
            echo "Using non-master branch format"
            SAFE_NAME=$(echo "${{ env.BRANCH_NAME }}" | tr '/' '-')
            TAG_NAME="${SAFE_NAME}-b${BUILD_NUMBER}-${SHORT_HASH}"
            SHOULD_RELEASE="false"
          fi

          echo "Final tag name: $TAG_NAME"
          echo "Should release: $SHOULD_RELEASE"
          echo "name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

  ubuntu-build:
    needs: determine-tag
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' || github.event.inputs.run_type == 'full-ci' || github.event.inputs.run_type == 'release-only' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x64
            extra_cmake: ""
    runs-on: ${{ matrix.os }}

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
          sudo apt-get update
          sudo apt-get install -y build-essential libsdl2-dev cmake libvulkan-dev vulkan-sdk

      - name: Configure
        run: |
          git config --global --add safe.directory /workspace
          cmake -S . -B build \
            -DWHISPER_SDL2=ON \
            -DGGML_VULKAN=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DGGML_STATIC=ON \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_SERVER=OFF \
            ${{ matrix.extra_cmake }}

      - name: Build
        run: cmake --build build --config Release -j $(nproc)

      - name: Package whisper-cli (Ubuntu)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
        run: |
          mkdir -p dist
          cp build/bin/whisper-cli dist/
          pushd dist
          zip -9 "whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-ubuntu-x64.zip" whisper-cli
          popd

      - name: Upload whisper-cli package
        if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-ubuntu
          path: dist/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-ubuntu-x64.zip

  macos-build:
    needs: determine-tag
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' || github.event.inputs.run_type == 'full-ci' || github.event.inputs.run_type == 'release-only' }}
    runs-on: macos-latest

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Dependencies
        run: |
          brew update
          cmake --version
          brew install sdl2

      - name: Build
        run: |
          sysctl -a
          git config --global --add safe.directory /workspace
          cmake -B build -G Xcode \
            -DGGML_METAL_USE_BF16=ON \
            -DGGML_METAL_EMBED_LIBRARY=ON \
            -DGGML_COREML=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DGGML_STATIC=ON \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_SERVER=OFF \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
          cmake --build build --config Release -j $(sysctl -n hw.logicalcpu)

      - name: Package whisper-cli (macOS)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
        run: |
          mkdir -p dist
          cp build/bin/Release/whisper-cli dist/
          pushd dist
          zip -9 "whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-macos-universal.zip" whisper-cli
          popd

      - name: Upload whisper-cli package (macOS)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-macos
          path: dist/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-macos-universal.zip

  windows-build:
    needs: determine-tag
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' || github.event.inputs.run_type == 'full-ci' || github.event.inputs.run_type == 'release-only' }}
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64]

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Install Vulkan SDK runtime components
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          function Invoke-WithRetry {
            param(
              [scriptblock] $Operation,
              [int] $MaxAttempts = 3,
              [int] $DelaySeconds = 5
            )

            for ($attempt = 1; $attempt -le $MaxAttempts; $attempt++) {
              try {
                & $Operation
                return
              } catch {
                if ($attempt -eq $MaxAttempts) { throw }
                Write-Warning "Attempt $attempt failed: $($_.Exception.Message). Retrying..."
                Start-Sleep -Seconds ([int][Math]::Min(30, $DelaySeconds * $attempt))
              }
            }
          }

          $sdkVersion = "1.4.328.1"
          $runtimeZip = "VulkanRT-X64-$sdkVersion-Components.zip"
          $downloadUrl = "https://sdk.lunarg.com/sdk/download/$sdkVersion/windows/$runtimeZip?Human=true"
          $runtimeRoot = "C:\\VulkanRT\\$sdkVersion"
          $extractRoot = Join-Path $env:RUNNER_TEMP "vulkanrt"

          if (Test-Path $runtimeRoot) {
            Write-Host "Cleaning previous Vulkan runtime root at $runtimeRoot"
            Remove-Item -Recurse -Force $runtimeRoot
          }
          if (Test-Path $extractRoot) {
            Remove-Item -Recurse -Force $extractRoot
          }
          New-Item -ItemType Directory -Path $extractRoot | Out-Null

          Invoke-WithRetry -Operation {
            Write-Host "Downloading Vulkan runtime components from $downloadUrl"
            $userAgent = "Mozilla/5.0 (Windows NT; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
            $requestParams = @{ Uri = $downloadUrl; OutFile = $runtimeZip; UseBasicParsing = $true; MaximumRetryCount = 5; RetryIntervalSec = 5; Headers = @{ "User-Agent" = $userAgent } }

            try {
              Invoke-WebRequest @requestParams | Out-Null
            } catch {
              throw "Failed to download runtime archive: $($_.Exception.Message)"
            }

            if (-not (Test-Path $runtimeZip)) {
              throw "Runtime archive not downloaded"
            }

            $fileInfo = Get-Item $runtimeZip
            if ($fileInfo.Length -lt 5MB) {
              throw "Runtime archive size too small: $($fileInfo.Length) bytes"
            }

            $fs = [IO.File]::OpenRead($runtimeZip)
            try {
              $signature = New-Object byte[] 2
              $null = $fs.Read($signature, 0, 2)
              if ($signature[0] -ne 0x50 -or $signature[1] -ne 0x4B) {
                throw "Runtime archive does not appear to be a ZIP (missing PK header)"
              }
            } finally {
              $fs.Dispose()
            }
          }

          Write-Host "Extracting Vulkan runtime components..."
          Expand-Archive -Path $runtimeZip -DestinationPath $extractRoot -Force

          $candidateRoots = Get-ChildItem -Path $extractRoot -Directory -Recurse | Where-Object {
            Test-Path (Join-Path $_.FullName "Include\\vulkan\\vulkan.h") -and \
            (Test-Path (Join-Path $_.FullName "Lib"))
          }

          if (-not $candidateRoots) {
            throw "Could not locate Vulkan runtime Include/Lib directories after extraction"
          }

          $foundRoot = $candidateRoots | Select-Object -First 1
          Write-Host "Using Vulkan runtime root at $($foundRoot.FullName)"
          New-Item -ItemType Directory -Path $runtimeRoot -Force | Out-Null
          Copy-Item -Path $foundRoot.FullName\* -Destination $runtimeRoot -Recurse -Force

          if (-not (Test-Path (Join-Path $runtimeRoot "Include\\vulkan\\vulkan.h"))) {
            throw "Vulkan runtime missing headers under $runtimeRoot"
          }
          if (-not (Test-Path (Join-Path $runtimeRoot "Lib"))) {
            throw "Vulkan runtime missing Lib directory under $runtimeRoot"
          }

          $env:VULKAN_SDK = $runtimeRoot
          "VULKAN_SDK=$($env:VULKAN_SDK)" >> $Env:GITHUB_ENV

          $binPath = Join-Path $env:VULKAN_SDK "Bin"
          if (Test-Path $binPath) {
            $binPath >> $Env:GITHUB_PATH
          }

      - name: Configure
        run: |
          git config --global --add safe.directory /workspace
          cmake -S . -B ./build -A ${{ matrix.arch }} `
            -DBUILD_SHARED_LIBS=OFF `
            -DGGML_STATIC=ON `
            -DGGML_VULKAN=ON `
            -DWHISPER_SDL2=OFF `
            -DWHISPER_BUILD_TESTS=OFF `
            -DWHISPER_BUILD_EXAMPLES=ON `
            -DWHISPER_BUILD_SERVER=OFF

      - name: Build
        run: |
          cd ./build
          msbuild ALL_BUILD.vcxproj -t:build -p:configuration=Release -p:platform=${{ matrix.arch }}

      - name: Package whisper-cli (Windows x64)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
        run: |
          mkdir dist
          Copy-Item "build/bin/Release/whisper-cli.exe" dist/
          Compress-Archive -Path "dist/whisper-cli.exe" -DestinationPath "dist/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-x64.zip"

      - name: Upload whisper-cli package (Windows x64)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-windows
          path: dist/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-x64.zip

  create-release:
    if: ${{ needs.determine-tag.outputs.should_release == 'true' || github.event.inputs.run_type == 'release-only' }}
    needs: [determine-tag, ubuntu-build, macos-build, windows-build]
    runs-on: ubuntu-latest

    steps:
      - name: Download Ubuntu package
        uses: actions/download-artifact@v4
        with:
          name: whisper-cli-ubuntu
          path: release

      - name: Download macOS package
        uses: actions/download-artifact@v4
        with:
          name: whisper-cli-macos
          path: release

      - name: Download Windows package
        uses: actions/download-artifact@v4
        with:
          name: whisper-cli-windows
          path: release

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determine-tag.outputs.tag_name }}
          files: |
            release/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-ubuntu-x64.zip
            release/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-macos-universal.zip
            release/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-x64.zip
          generate_release_notes: true
          prerelease: ${{ github.ref_type != 'tag' }}
