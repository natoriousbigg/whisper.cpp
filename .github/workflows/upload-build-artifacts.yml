name: Upload Build Artifacts

permissions:
  contents: write

on:
  workflow_call:

jobs:
  upload-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set release info
        id: release-info
        run: |
          echo "date=$(date -u +'%Y%m%d-%H%M')" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse --short=7 HEAD)" >> "$GITHUB_OUTPUT"

      - name: Check for existing release with same commit
        id: check-release
        run: |
          TAG="preview-builds-${{ steps.release-info.outputs.commit }}"
          echo "Checking if release with tag $TAG exists..."
          if gh release view "$TAG" --json tagName &>/dev/null; then
            echo "release_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "release_exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download Artifacts
        if: steps.check-release.outputs.release_exists != 'true'
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          pattern: whisper-cli-*
          path: artifacts
          merge-multiple: false

      - name: Create release packages
        if: steps.check-release.outputs.release_exists != 'true'
        run: |
          RELEASE_DIR="$(pwd)/release"
          mkdir -p "$RELEASE_DIR"
          
          # Create zip file for each artifact directory
          for dir in artifacts/whisper-cli-*/; do
            if [ -d "$dir" ]; then
              artifact_name=$(basename "$dir")
              zip_file="${RELEASE_DIR}/${artifact_name}.zip"
              
              echo "Creating $zip_file from $dir"
              
              pushd "$dir" > /dev/null
              zip -9 "$zip_file" *
              popd > /dev/null
            fi
          done
          
          # Also create a combined archive
          zip -r "${RELEASE_DIR}/all-builds.zip" artifacts/

      - name: Create preview release
        if: steps.check-release.outputs.release_exists != 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: preview-builds-${{ steps.release-info.outputs.commit }}
          name: Preview Builds ${{ steps.release-info.outputs.date }} (${{ steps.release-info.outputs.commit }})
          artifacts: release/*.zip
          prerelease: true
          body: |
            These are preview builds from commit `${{ steps.release-info.outputs.commit }}`.

            This release was automatically generated on `${{ steps.release-info.outputs.date }}`.
            
            ## Included Builds
            - Ubuntu x64 (Vulkan, CUDA, No AVX512)
            - macOS Universal (Metal, CoreML)
            - Windows x64 (Vulkan, CUDA, No AVX512, OpenVINO)
