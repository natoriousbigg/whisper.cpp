name: Ubuntu Vulkan Build

permissions:
  contents: read

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      upload_artifacts:
        required: false
        type: boolean
        default: true

jobs:
  build:
    name: Ubuntu x64 (Vulkan)
    runs-on: ubuntu-22.04
    env:
      ARCH: x64
      DEB_ARCH: amd64
      TRIPLET: x86_64-linux-gnu
      COMPILER_PACKAGES: ""
      BLAS_PACKAGE: ""
      PACKAGE_SUFFIX: "-vulkan"
      EXTRA_CMAKE: "-DWHISPER_SDL2=ON"
      VULKAN_SDK_VERSION: "1.4.328.1"

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Cache Vulkan SDK
        id: cache-vulkan
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vulkan-sdk
          key: ${{ runner.os }}-vulkan-${{ env.VULKAN_SDK_VERSION }}
          restore-keys: |
            ${{ runner.os }}-vulkan-${{ env.VULKAN_SDK_VERSION }}

      - name: Check Vulkan cache status
        id: vulkan-cache-check
        run: |
          VULKAN_PATH="${{ github.workspace }}/vulkan-sdk/${{ env.VULKAN_SDK_VERSION }}/x86_64"
          echo "Checking for Vulkan SDK at: $VULKAN_PATH"
          echo "Cache hit output: '${{ steps.cache-vulkan.outputs.cache-hit }}'"
          
          if [ -d "${{ github.workspace }}/vulkan-sdk" ]; then
            echo "Contents of vulkan-sdk directory:"
            ls -la "${{ github.workspace }}/vulkan-sdk" || true
          else
            echo "vulkan-sdk directory does not exist"
          fi
          
          if [ -d "$VULKAN_PATH" ] && [ -d "$VULKAN_PATH/bin" ]; then
            echo "Vulkan SDK cache restored - using cached installation"
            echo "Installation time saved: ~2-3 minutes"
            echo "cache_restored=true" >> $GITHUB_OUTPUT
          else
            echo "Vulkan SDK cache miss - will install and cache for future runs"
            echo "This will take approximately 2-3 minutes"
            echo "cache_restored=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Vulkan SDK
        if: steps.vulkan-cache-check.outputs.cache_restored != 'true'
        run: |
          mkdir -p ${{ github.workspace }}/vulkan-sdk
          cd ${{ github.workspace }}/vulkan-sdk
          
          SDK_FILENAME="vulkansdk-linux-x86_64-${{ env.VULKAN_SDK_VERSION }}.tar.xz"
          
          echo "Downloading Vulkan SDK ${{ env.VULKAN_SDK_VERSION }}..."
          if ! wget -q --show-progress "https://sdk.lunarg.com/sdk/download/${{ env.VULKAN_SDK_VERSION }}/linux/${SDK_FILENAME}"; then
            echo "Error: Failed to download Vulkan SDK"
            exit 1
          fi
          
          echo "Extracting Vulkan SDK..."
          if ! tar -xf "${SDK_FILENAME}"; then
            echo "Error: Failed to extract Vulkan SDK"
            exit 1
          fi
          rm "${SDK_FILENAME}"
          
          if [ ! -d "${{ env.VULKAN_SDK_VERSION }}/x86_64" ]; then
            echo "Error: Vulkan SDK directory structure not found after extraction"
            exit 1
          fi
          echo "Vulkan SDK installation completed successfully"

      - name: Set Vulkan environment
        run: |
          echo "VULKAN_SDK=${{ github.workspace }}/vulkan-sdk/${{ env.VULKAN_SDK_VERSION }}/x86_64" >> $GITHUB_ENV
          echo "${{ github.workspace }}/vulkan-sdk/${{ env.VULKAN_SDK_VERSION }}/x86_64/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/vulkan-sdk/${{ env.VULKAN_SDK_VERSION }}/x86_64/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}" >> $GITHUB_ENV
          echo "VK_LAYER_PATH=${{ github.workspace }}/vulkan-sdk/${{ env.VULKAN_SDK_VERSION }}/x86_64/etc/vulkan/explicit_layer.d" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture ${DEB_ARCH}
          sudo apt-get update
          EXTRA_PACKAGES=""
          if [[ -n "${BLAS_PACKAGE}" ]]; then
            EXTRA_PACKAGES="${BLAS_PACKAGE}:${DEB_ARCH}"
          fi
          sudo apt-get install -y build-essential cmake ninja-build pkg-config \
            ${COMPILER_PACKAGES} \
            libsdl2-dev:${DEB_ARCH} \
            libvulkan1:${DEB_ARCH} \
            libxcb1-dev libxcb-keysyms1-dev libx11-xcb-dev \
            $EXTRA_PACKAGES

      - name: Configure
        run: |
          git config --global --add safe.directory /workspace
          export PKG_CONFIG_LIBDIR="/usr/lib/${TRIPLET}/pkgconfig:/usr/share/pkgconfig"
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DGGML_VULKAN=ON \
            -DGGML_AVX512=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DGGML_STATIC=ON \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_SERVER=OFF \
            ${EXTRA_CMAKE}

      - name: Build
        run: cmake --build build --config Release -j $(nproc)

      - name: Package whisper-cli
        if: ${{ inputs.upload_artifacts }}
        run: |
          mkdir -p dist
          cp build/bin/whisper-cli dist/

      - name: Upload artifacts
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-ubuntu-${{ env.ARCH }}${{ env.PACKAGE_SUFFIX }}
          path: dist/*

      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf build dist
          sudo rm -rf /var/cache/apt/archives || true
