name: Windows Vulkan Build

permissions:
  contents: read

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      upload_artifacts:
        required: false
        type: boolean
        default: true

jobs:
  build:
    name: Windows x64 (Vulkan)
    runs-on: windows-latest
    env:
      VULKAN_SDK_VERSION: "1.4.328.1"

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Install Ninja
        run: choco install ninja -y

      - name: Cache Vulkan SDK
        id: cache-vulkan
        uses: actions/cache@v4
        with:
          path: C:\VulkanSDK
          key: ${{ runner.os }}-vulkan-${{ env.VULKAN_SDK_VERSION }}
          restore-keys: |
            ${{ runner.os }}-vulkan-${{ env.VULKAN_SDK_VERSION }}

      - name: Check Vulkan cache status
        id: vulkan-cache-check
        shell: powershell
        run: |
          $vulkanPath = "C:\VulkanSDK"
          Write-Host "Checking for Vulkan SDK at: $vulkanPath"
          Write-Host "Cache hit output: '${{ steps.cache-vulkan.outputs.cache-hit }}'"
          
          if (Test-Path $vulkanPath) {
            Write-Host "Contents of VulkanSDK directory:"
            Get-ChildItem $vulkanPath | Format-Table -AutoSize
          } else {
            Write-Host "VulkanSDK directory does not exist"
          }
          
          if ((Test-Path $vulkanPath) -and (Get-ChildItem $vulkanPath -Directory | Where-Object { Test-Path (Join-Path $_.FullName "Bin") })) {
            Write-Host "Vulkan SDK cache restored - using cached installation"
            Write-Host "Installation time saved: ~2-3 minutes"
            "cache_restored=true" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "Vulkan SDK cache miss - will install and cache for future runs"
            Write-Host "This will take approximately 2-3 minutes"
            "cache_restored=false" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Install Vulkan SDK
        if: steps.vulkan-cache-check.outputs.cache_restored != 'true'
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Vulkan SDK cache miss - installing"
          Write-Host "Installing Vulkan SDK via winget"

          $installArgs = @(
            'install',
            '--id', 'KhronosGroup.VulkanSDK',
            '--accept-package-agreements',
            '--accept-source-agreements',
            '--silent',
            '--source', 'winget'
          )

          winget @installArgs

          if ($LASTEXITCODE -ne 0) {
            Write-Error "winget failed to install Vulkan SDK (exit $LASTEXITCODE)"
            exit $LASTEXITCODE
          }

      - name: Locate Vulkan SDK
        shell: powershell
        run: |
          $searchRoots = @(
            "C:\\VulkanSDK",
            "$Env:ProgramFiles\\VulkanSDK",
            "$Env:ProgramFiles(x86)\\VulkanSDK"
          )

          $sdkRoot = $null
          foreach ($root in $searchRoots) {
            if (-not (Test-Path $root)) {
              continue
            }

            $candidate = Get-ChildItem $root -Directory | Sort-Object Name -Descending | Select-Object -First 1
            if ($candidate) {
              $sdkRoot = $candidate.FullName
              break
            }
          }

          if (-not $sdkRoot) {
            Write-Error "Vulkan SDK not found"
            exit 1
          }
          
          $cacheRestored = '${{ steps.vulkan-cache-check.outputs.cache_restored }}'
          if ($cacheRestored -eq 'true') {
            Write-Host "Using cached Vulkan SDK installation at: $sdkRoot"
          } else {
            Write-Host "Vulkan SDK installed at: $sdkRoot"
          }

          "VULKAN_SDK=$sdkRoot" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Configure
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          if not defined VULKAN_SDK exit /b 1
          set "PATH=%VULKAN_SDK%\Bin;%PATH%"
          cmake -S . -B build -G "Ninja" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DGGML_AVX512=ON ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DGGML_STATIC=ON ^
            -DGGML_VULKAN=ON ^
            -DWHISPER_SDL2=OFF ^
            -DWHISPER_BUILD_TESTS=OFF ^
            -DWHISPER_BUILD_EXAMPLES=ON ^
            -DWHISPER_BUILD_SERVER=OFF

      - name: Build
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          if not defined VULKAN_SDK exit /b 1
          set "PATH=%VULKAN_SDK%\Bin;%PATH%"
          cmake --build build --config Release -- -v

      - name: Package whisper-cli and whisper-bench
        if: ${{ inputs.upload_artifacts }}
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          
          Copy-Item build\bin\whisper-cli.exe dist\
          Copy-Item build\bin\whisper-bench.exe dist\
          
          if (Test-Path "build\bin\*.dll") {
            Copy-Item build\bin\*.dll dist\
          }

      - name: Upload artifacts
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-windows-x64-vulkan
          path: dist/*
