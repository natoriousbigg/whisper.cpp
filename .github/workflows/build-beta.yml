name: CI Beta (OpenVINO)

on:
  push:
    branches:
      - master
      - copilot/**
    paths: 
      - '.github/workflows/build-beta.yml'
      - '**/CMakeLists.txt'
      - '**/*.h'
      - '**/*.hpp'
      - '**/*.c'
      - '**/*.cpp'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create new release'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  determine-tag:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.name }}
      should_release: ${{ steps.tag.outputs.should_release }}

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        shell: bash
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          CUSTOM_TAG="${{ github.event.inputs.pre_release_tag }}"
          SHOULD_RELEASE="false"

          if [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            SHOULD_RELEASE="true"
            TAG_NAME="beta-b${BUILD_NUMBER}"
          else
            TAG_NAME="beta-b${BUILD_NUMBER}-${SHORT_HASH}"
          fi

          echo "Tag name: $TAG_NAME"
          echo "Should release: $SHOULD_RELEASE"
          echo "name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

  windows-build-openvino:
    needs: determine-tag
    name: Windows x64 (OpenVINO)
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64

    runs-on: windows-latest
    
    env:
      OPENVINO_VERSION: "2024.6.0"

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          choco install ninja -y
          python -m pip install --upgrade pip

      - name: Install OpenVINO via Python
        shell: powershell
        run: |
          Write-Host "Setting up Python environment for OpenVINO installation..."
          
          python -m pip install openvino==${{ env.OPENVINO_VERSION }}
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to install OpenVINO Python package"
          }
          
          Write-Host "OpenVINO Python package installed successfully"
          
          Write-Host "Locating OpenVINO installation..."
          $openvinoPath = python -c "import openvino; import os; print(os.path.dirname(openvino.__file__))"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to locate OpenVINO installation"
          }
          
          Write-Host "OpenVINO installed at: $openvinoPath"
          
          $runtimePath = Join-Path $openvinoPath "runtime"
          if (!(Test-Path $runtimePath)) {
            $runtimePath = Join-Path $openvinoPath ".."  | Join-Path -ChildPath "runtime"
          }
          
          if (!(Test-Path $runtimePath)) {
            throw "Could not find OpenVINO runtime directory"
          }
          
          Write-Host "Configuring environment variables..."
          
          $cmakePath = Join-Path $openvinoPath "cmake"
          if (!(Test-Path $cmakePath)) {
            $cmakePath = Join-Path $runtimePath "cmake"
          }
          
          if (Test-Path $cmakePath) {
            "OpenVINO_DIR=$cmakePath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "Set OpenVINO_DIR=$cmakePath"
          } else {
            throw "Could not find OpenVINO cmake directory at any expected location"
          }
          
          $binPath = Join-Path $runtimePath "bin" | Join-Path -ChildPath "intel64" | Join-Path -ChildPath "Release"
          if (Test-Path $binPath) {
            "$binPath" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Added to PATH: $binPath"
          }
          
          $tbbPath = Join-Path $runtimePath "3rdparty" | Join-Path -ChildPath "tbb" | Join-Path -ChildPath "bin"
          if (Test-Path $tbbPath) {
            "$tbbPath" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Added to PATH: $tbbPath"
          }
          
          Write-Host "[OK] OpenVINO configuration completed successfully"

      - name: Configure (OpenVINO)
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          cmake -S . -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DGGML_AVX512=ON ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DGGML_STATIC=ON ^
            -DGGML_VULKAN=OFF ^
            -DWHISPER_OPENVINO=ON ^
            -DWHISPER_SDL2=OFF ^
            -DWHISPER_BUILD_TESTS=OFF ^
            -DWHISPER_BUILD_EXAMPLES=ON ^
            -DWHISPER_BUILD_SERVER=OFF

      - name: Build (OpenVINO)
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          cmake --build build --config Release -- -v

      - name: Package whisper-cli and whisper-bench (Windows ${{ matrix.arch }} OpenVINO)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' }}
        shell: powershell
        run: |
          # Create dist directory
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          
          # Copy executables
          Copy-Item build\bin\whisper-cli.exe dist\
          Copy-Item build\bin\whisper-bench.exe dist\
          
          # Copy any build DLLs if they exist
          if (Test-Path "build\bin\*.dll") {
            Copy-Item build\bin\*.dll dist\
          }
          
          # Copy OpenVINO runtime DLLs
          # Try vcpkg installed location first
          $vcpkgOpenvinoPath = "$env:VCPKG_ROOT\installed\x64-windows\bin"
          if (Test-Path $vcpkgOpenvinoPath) {
            Write-Host "Copying OpenVINO DLLs from vcpkg: $vcpkgOpenvinoPath"
            Get-ChildItem "$vcpkgOpenvinoPath\*.dll" -ErrorAction SilentlyContinue | Copy-Item -Destination dist\
          } else {
            # Fallback to manual installation path
            $openvinoPath = "C:\openvino"
            if (Test-Path "$openvinoPath\runtime\bin\intel64\Release") {
              Write-Host "Copying OpenVINO runtime DLLs..."
              Copy-Item "$openvinoPath\runtime\bin\intel64\Release\*.dll" dist\
            }
            
            # Copy TBB DLLs if they exist
            $tbbPath = "$openvinoPath\runtime\3rdparty\tbb\bin"
            if (Test-Path $tbbPath) {
              Write-Host "Copying TBB DLLs from: $tbbPath"
              $tbbDlls = Get-ChildItem "$tbbPath\*.dll" -ErrorAction SilentlyContinue
              if ($tbbDlls) {
                $tbbDlls | Copy-Item -Destination dist\
                Write-Host "Copied $($tbbDlls.Count) TBB DLL(s)"
              }
            }
          }
          
          # Create zip package
          Push-Location dist
          $filesToZip = @(Get-ChildItem -Path "*.exe" -Name)
          if (Test-Path "*.dll") {
            $filesToZip += @(Get-ChildItem -Path "*.dll" -Name)
          }
          tar.exe -a -c -f ..\whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-${{ matrix.arch }}-openvino.zip $filesToZip
          Pop-Location
          Move-Item whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-${{ matrix.arch }}-openvino.zip dist\

      - name: Upload whisper-cli package (Windows ${{ matrix.arch }} OpenVINO)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-windows-${{ matrix.arch }}-openvino
          path: dist/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-${{ matrix.arch }}-openvino.zip

  create-release:
    if: ${{ needs.determine-tag.outputs.should_release == 'true' }}
    needs: [determine-tag, windows-build-openvino]
    runs-on: ubuntu-latest

    steps:
      - name: Download whisper-cli packages
        uses: actions/download-artifact@v4
        with:
          pattern: whisper-cli-*
          path: release
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determine-tag.outputs.tag_name }}
          files: |
            release/*
          generate_release_notes: true
          prerelease: true
