name: CI Beta (OpenVINO)

on:
  push:
    branches:
      - master
      - copilot/**
    paths: 
      - '.github/workflows/build-beta.yml'
      - '**/CMakeLists.txt'
      - '**/*.h'
      - '**/*.hpp'
      - '**/*.c'
      - '**/*.cpp'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '.github/workflows/build-beta.yml'
      - '**/CMakeLists.txt'
      - '**/*.h'
      - '**/*.hpp'
      - '**/*.c'
      - '**/*.cpp'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create new release'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  determine-tag:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.name }}
      should_release: ${{ steps.tag.outputs.should_release }}

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        shell: bash
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          CUSTOM_TAG="${{ github.event.inputs.pre_release_tag }}"
          SHOULD_RELEASE="false"

          if [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            SHOULD_RELEASE="true"
            TAG_NAME="beta-b${BUILD_NUMBER}"
          else
            TAG_NAME="beta-b${BUILD_NUMBER}-${SHORT_HASH}"
          fi

          echo "Tag name: $TAG_NAME"
          echo "Should release: $SHOULD_RELEASE"
          echo "name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

  windows-build-openvino:
    needs: determine-tag
    name: Windows x64 (OpenVINO)
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64

    runs-on: windows-latest
    
    env:
      OPENVINO_VERSION: "2024.6.0"
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      - name: Clone
        uses: actions/checkout@v4

      - name: Install Ninja
        run: choco install ninja -y

      - name: Setup vcpkg (latest)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '01f602195983451bc83e72f4214af2cbc495aa94'

      - name: Install OpenVINO via vcpkg
        shell: powershell
        run: |
          Write-Host "Installing OpenVINO via vcpkg with binary caching..."
          Write-Host "Binary caching enabled via VCPKG_BINARY_SOURCES env var"
          
          try {
            vcpkg install openvino:x64-windows --binarysource="clear;x-gha,readwrite"
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "[OK] OpenVINO installed successfully via vcpkg"
            } else {
              throw "vcpkg install failed with exit code $LASTEXITCODE"
            }
          } catch {
            Write-Host "ERROR: vcpkg installation failed"
            Write-Host "Error: $_"
            Write-Host ""
            Write-Host "Falling back to manual OpenVINO installation..."
            
            $ErrorActionPreference = 'Stop'
            $url = "https://storage.openvinotoolkit.org/repositories/openvino/packages/${{ env.OPENVINO_VERSION }}/windows/w_openvino_toolkit_windows_${{ env.OPENVINO_VERSION }}.zip"
            $zipFile = "C:\openvino_installer.zip"
            $installPath = "C:\openvino"
            
            Write-Host "Downloading OpenVINO from: $url"
            Write-Host "This may take several minutes (file is ~500MB)..."
            
            $ProgressPreference = 'SilentlyContinue'
            Invoke-WebRequest -Uri $url -OutFile $zipFile -UseBasicParsing -TimeoutSec 1800
            $ProgressPreference = 'Continue'
            
            if (-not (Test-Path $zipFile)) {
              throw "Downloaded file not found"
            }
            
            $fileSize = (Get-Item $zipFile).Length / 1MB
            Write-Host "Downloaded: $([math]::Round($fileSize, 2)) MB"
            
            if ($fileSize -lt 100) {
              throw "File too small: $([math]::Round($fileSize, 2)) MB"
            }
            
            Write-Host "Extracting..."
            Expand-Archive -Path $zipFile -DestinationPath C:\openvino_temp -Force
            
            $extractedDir = Get-ChildItem C:\openvino_temp -Directory | Select-Object -First 1
            if (!$extractedDir) {
              throw "No directory in archive"
            }
            
            New-Item -ItemType Directory -Force -Path $installPath | Out-Null
            Move-Item -Path "$($extractedDir.FullName)\*" -Destination $installPath -Force
            
            Remove-Item $zipFile -Force -ErrorAction SilentlyContinue
            Remove-Item C:\openvino_temp -Recurse -Force -ErrorAction SilentlyContinue
            
            if (!(Test-Path "$installPath\runtime")) {
              throw "Runtime directory not found after installation"
            }
            
            $cmakePath = "$installPath\runtime\cmake"
            "OpenVINO_DIR=$cmakePath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
            "$installPath\runtime\bin\intel64\Release" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
            "$installPath\runtime\3rdparty\tbb\bin" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
            
            Write-Host "[OK] Manual installation completed"
          }

      - name: Configure (OpenVINO)
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          cmake -S . -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DGGML_AVX512=ON ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DGGML_STATIC=ON ^
            -DGGML_VULKAN=OFF ^
            -DWHISPER_OPENVINO=ON ^
            -DWHISPER_SDL2=OFF ^
            -DWHISPER_BUILD_TESTS=OFF ^
            -DWHISPER_BUILD_EXAMPLES=ON ^
            -DWHISPER_BUILD_SERVER=OFF ^
            -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake

      - name: Build (OpenVINO)
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VS_PATH=%%i
          if not defined VS_PATH exit /b 1
          call "%VS_PATH%\Common7\Tools\VsDevCmd.bat" -host_arch=x64 -arch=x64
          cmake --build build --config Release -- -v

      - name: Package whisper-cli and whisper-bench (Windows ${{ matrix.arch }} OpenVINO)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' }}
        shell: powershell
        run: |
          # Create dist directory
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          
          # Copy executables
          Copy-Item build\bin\whisper-cli.exe dist\
          Copy-Item build\bin\whisper-bench.exe dist\
          
          # Copy any build DLLs if they exist
          if (Test-Path "build\bin\*.dll") {
            Copy-Item build\bin\*.dll dist\
          }
          
          # Copy OpenVINO runtime DLLs
          # Try vcpkg installed location first
          $vcpkgOpenvinoPath = "$env:VCPKG_ROOT\installed\x64-windows\bin"
          if (Test-Path $vcpkgOpenvinoPath) {
            Write-Host "Copying OpenVINO DLLs from vcpkg: $vcpkgOpenvinoPath"
            Get-ChildItem "$vcpkgOpenvinoPath\*.dll" -ErrorAction SilentlyContinue | Copy-Item -Destination dist\
          } else {
            # Fallback to manual installation path
            $openvinoPath = "C:\openvino"
            if (Test-Path "$openvinoPath\runtime\bin\intel64\Release") {
              Write-Host "Copying OpenVINO runtime DLLs..."
              Copy-Item "$openvinoPath\runtime\bin\intel64\Release\*.dll" dist\
            }
            
            # Copy TBB DLLs if they exist
            $tbbPath = "$openvinoPath\runtime\3rdparty\tbb\bin"
            if (Test-Path $tbbPath) {
              Write-Host "Copying TBB DLLs from: $tbbPath"
              $tbbDlls = Get-ChildItem "$tbbPath\*.dll" -ErrorAction SilentlyContinue
              if ($tbbDlls) {
                $tbbDlls | Copy-Item -Destination dist\
                Write-Host "Copied $($tbbDlls.Count) TBB DLL(s)"
              }
            }
          }
          
          # Create zip package
          Push-Location dist
          $filesToZip = @(Get-ChildItem -Path "*.exe" -Name)
          if (Test-Path "*.dll") {
            $filesToZip += @(Get-ChildItem -Path "*.dll" -Name)
          }
          tar.exe -a -c -f ..\whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-${{ matrix.arch }}-openvino.zip $filesToZip
          Pop-Location
          Move-Item whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-${{ matrix.arch }}-openvino.zip dist\

      - name: Upload whisper-cli package (Windows ${{ matrix.arch }} OpenVINO)
        if: ${{ needs.determine-tag.outputs.should_release == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cli-windows-${{ matrix.arch }}-openvino
          path: dist/whisper-cli-${{ needs.determine-tag.outputs.tag_name }}-windows-${{ matrix.arch }}-openvino.zip

  create-release:
    if: ${{ needs.determine-tag.outputs.should_release == 'true' }}
    needs: [determine-tag, windows-build-openvino]
    runs-on: ubuntu-latest

    steps:
      - name: Download whisper-cli packages
        uses: actions/download-artifact@v4
        with:
          pattern: whisper-cli-*
          path: release
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determine-tag.outputs.tag_name }}
          files: |
            release/*
          generate_release_notes: true
          prerelease: true
